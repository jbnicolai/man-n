#!/bin/sh

#
# Constants.
#

original="$(which man)"
input="$(mktemp -t "manXXXXX")"
prefix="$(dirname "$0")/$(dirname "$(readlink "$0")")/../node_modules"
mdast="$prefix/.bin/mdast"
mdastMan="$prefix/mdast-man"
badges="$prefix/mdast-strip-badges"

#
# Usage.
#

usage () {
cat << EOF
  Usage: man-n [options] <package>

  Options:

    -h, --help  output usage information
    -l, --link  link \`man-n\` to \`man n\`

  Examples:

    $ man-n browserify  # show the browserify documentation
    $ man-n --link      # link \`man-n\` to \`man n\`
    $ man n browserify  # show the browserify documentation
EOF
}

#
# If `--linked`, detect if this is a `n` page.
#

if [ "$1" = "--linked" ]; then shift;
  if [ "$1" = "n" ]; then shift;
  else
    "$original" "$@"
    exit
  fi
fi

#
# Trigger help.
#

readonly name="$1"
[ ! "$name" ] && usage && exit 1
[ "$name" = '-h' ] && usage && exit 0
[ "$name" = '--help' ] && usage && exit 0

#
# Link.
#

if [ "$name" = "--link" ]; then
  echo "alias \"man=man-n --linked\""
  exit
fi

#
# Options.
#

readonly description="$(npm view "$name" description)"
readonly version="$(npm view "$name" version)"
readonly section="n"
readonly manual="npm"

readonly options="name:\"$name\",version:\"$version\",section:\"$section\",description:\"$description\",manual:\"$manual\""

#
# Create man-page.
#

npm view "$name" readme |
  $mdast --no-ignore --no-rc --silent --use "$badges" --use "$mdastMan=$options" > "$input"

#
# Show man page.
#

man "$input"
